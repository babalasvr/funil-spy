<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obrigado pela Sua Compra!</title>
    
    <!-- UTM Tracking Script -->
    <script
      src="https://cdn.utmify.com.br/scripts/utms/latest.js"
      data-utmify-prevent-xcod-sck
      data-utmify-prevent-subids
      async
      defer
    ></script>
    
    <!-- UTMify Pixel Integration -->
    <script src="../analytics/public/utmify-pixel-integration.js"></script>
    
    <!-- UTMify Pixel -->
    <script>
        window.pixelId = "66ac66dd43136b1d66bddb65";
        var a = document.createElement("script");
        a.setAttribute("async", "");
        a.setAttribute("defer", "");
        a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
        document.head.appendChild(a);
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .thank-you-box {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 40px;
            margin: 50px 0;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #4CAF50;
            font-size: 32px;
            margin-bottom: 15px;
        }
        
        .header p {
            color: #666;
            font-size: 18px;
        }
        
        .confirmation-icon {
            font-size: 80px;
            color: #4CAF50;
            margin-bottom: 30px;
        }
        
        .next-steps {
            background-color: #f5f5f5;
            padding: 25px;
            border-radius: 8px;
            margin: 30px 0;
            text-align: left;
        }
        
        .next-steps h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .next-steps ol {
            margin-left: 20px;
        }
        
        .next-steps li {
            margin-bottom: 10px;
        }
        
        .support-info {
            margin: 30px 0;
        }
        
        .support-info h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .support-info p {
            margin-bottom: 10px;
        }
        
        .support-email {
            color: #2196F3;
            text-decoration: none;
            font-weight: bold;
        }
        
        .button {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            margin: 25px 0;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .button:hover {
            background-color: #45a049;
        }
        
        .order-details {
            margin: 30px 0;
            padding: 20px;
            border: 1px dashed #ccc;
            border-radius: 8px;
        }
        
        .order-details h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .order-id {
            font-family: monospace;
            background-color: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            font-size: 16px;
            display: inline-block;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .thank-you-box {
                padding: 25px;
                margin: 30px 0;
            }
            
            .header h1 {
                font-size: 28px;
            }
            
            .confirmation-icon {
                font-size: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="thank-you-box">
            <div class="confirmation-icon">✅</div>
            
            <div class="header">
                <h1>Obrigado pela Sua Compra!</h1>
                <p>Seu pedido foi processado com sucesso</p>
            </div>
            
            <div class="order-details">
                <h3>Detalhes do Pedido</h3>
                <p>Plano: <strong id="orderTitle">Acesso Básico</strong></p>
                <p>Descrição: <span id="orderDesc">Acesso ao sistema básico de monitoramento</span></p>
                <p>Número do Pedido: <span class="order-id" id="orderNumber">WS-123456</span></p>
                <p>Data da Compra: <span id="purchaseDate">26/08/2023</span></p>
            </div>
            
            <div class="next-steps">
                <h2>Próximos Passos:</h2>
                <ol>
                    <li><strong>Verifique seu e-mail</strong> - Enviamos as instruções de acesso para o endereço de e-mail fornecido durante a compra.</li>
                    <li><strong>Instale o aplicativo</strong> - Siga as instruções no e-mail para instalar e configurar o app de monitoramento.</li>
                    <li><strong>Ative sua conta</strong> - Use o código de ativação enviado por e-mail para ativar todos os recursos da sua compra.</li>
                </ol>
            </div>
            
            <div class="support-info">
                <h3>Precisa de Ajuda?</h3>
                <p>Nossa equipe de suporte está pronta para ajudar com qualquer dúvida.</p>
                <p>E-mail: <a href="mailto:suporte@whatspy.pro" class="support-email">suporte@whatspy.pro</a></p>
                <p>Horário de atendimento: Segunda a Sexta, 9h às 18h</p>
            </div>
            
            <a href="https://drive.google.com/drive/folders/1Kv9R4EBN1ock26Y3jK3uHnOEtl-ApxTD?usp=drive_link" class="button" id="accessButton">Acessar Produto</a>
        </div>
    </div>
    
    <script>
        // Gerar número de pedido aleatório
        function generateOrderNumber() {
            const prefix = "WS-";
            const randomNum = Math.floor(100000 + Math.random() * 900000);
            return prefix + randomNum;
        }
        
        // Formatar data atual
        function getCurrentDate() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Mostrar informações de compra com base no parâmetro da URL
        function showPurchaseInfo() {
            const urlParams = new URLSearchParams(window.location.search);
            const purchaseType = urlParams.get('purchase');
            const orderTitle = document.getElementById('orderTitle');
            const orderDesc = document.getElementById('orderDesc');
            
            // Valores padrão
            let title = "Acesso Básico";
            let desc = "Acesso ao sistema básico de monitoramento";
            
            // Ajustar com base no tipo de compra
            if (purchaseType === 'combo') {
                title = "Kit Investigador Profissional";
                desc = "Acesso Premium + Revelação Total + Alertas em Tempo Real";
            } else if (purchaseType === 'recurso') {
                title = "Revelador de Mensagens Ocultas";
                desc = "Acesso Básico + Recursos de Revelação de Mensagens";
            } else if (purchaseType === 'mini') {
                title = "Mini Pacote de Alertas";
                desc = "Acesso Básico + Sistema de Alertas";
            }
            
            // Atualizar elementos na página
            if (orderTitle) orderTitle.textContent = title;
            if (orderDesc) orderDesc.textContent = desc;
        }
        
        // Redirecionamento automático após 15 segundos
        function setupAutoRedirect() {
            const button = document.getElementById('accessButton');
            let seconds = 15;
            
            // Atualizar texto do botão com contagem regressiva
            button.innerHTML = `Acessar Produto (${seconds}s)`;
            
            const countdown = setInterval(() => {
                seconds--;
                if (seconds <= 0) {
                    clearInterval(countdown);
                    window.location.href = "https://drive.google.com/drive/folders/1Kv9R4EBN1ock26Y3jK3uHnOEtl-ApxTD?usp=drive_link";
                } else {
                    button.innerHTML = `Acessar Produto (${seconds}s)`;
                }
            }, 1000);
        }
        
        // Enviar evento Purchase para Facebook CAPI
        async function sendPurchaseEvent() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const purchaseType = urlParams.get('purchase') || 'basic';
                
                // Dados do checkout (simulados - em produção viriam do processo de compra)
                const checkoutData = {
                    name: urlParams.get('name') || 'Cliente',
                    email: urlParams.get('email') || 'cliente@email.com',
                    phone: urlParams.get('phone') || '+5511999999999',
                    total: parseFloat(getPurchaseValue(purchaseType)) // Garantir que seja número
                };
                
                // Capturar dados UTM via UTMify
                const utmData = window.utmify ? await window.utmify.getUTMData() : {};
                
                // Configurações do evento
                const options = {
                    currency: 'BRL',
                    contentName: getPurchaseTitle(purchaseType),
                    contentCategory: 'Digital Product',
                    actionSource: 'website', // Melhor para eventos originados do site
                    eventSourceUrl: window.location.href, // URL atual da página obrigado
                    eventId: generateUniqueEventId(checkoutData) // Event ID único para deduplicação
                };
                
                // Enviar para o backend com formato otimizado
                const response = await fetch('/analytics/api/utmify-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_name: 'Purchase',
                        event_time: Math.floor(Date.now() / 1000), // Unix timestamp
                        checkout: checkoutData,
                        utm: utmData,
                        options: options
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Evento Purchase enviado com sucesso:', result);
                } else {
                    console.error('❌ Erro ao enviar evento Purchase:', response.status);
                }
                
            } catch (error) {
                console.error('❌ Erro no envio do evento Purchase:', error);
            }
        }
        
        // Gerar Event ID único para deduplicação
        function generateUniqueEventId(checkoutData) {
            const timestamp = Date.now();
            const userIdentifier = checkoutData.email || checkoutData.phone || 'anonymous';
            const baseString = `Purchase_${userIdentifier}_${timestamp}`;
            
            // Simular hash MD5 (em produção usar crypto)
            let hash = 0;
            for (let i = 0; i < baseString.length; i++) {
                const char = baseString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16).substring(0, 16);
        }
        
        // Obter valor da compra baseado no tipo
        function getPurchaseValue(purchaseType) {
            switch (purchaseType) {
                case 'combo': return '497.00';
                case 'recurso': return '297.00';
                case 'mini': return '97.00';
                default: return '197.00';
            }
        }
        
        // Obter título da compra baseado no tipo
        function getPurchaseTitle(purchaseType) {
            switch (purchaseType) {
                case 'combo': return 'Kit Investigador Profissional';
                case 'recurso': return 'Revelador de Mensagens Ocultas';
                case 'mini': return 'Mini Pacote de Alertas';
                default: return 'Acesso Básico';
            }
        }
        
        // Preencher informações dinâmicas
        window.onload = function() {
            document.getElementById('orderNumber').textContent = generateOrderNumber();
            document.getElementById('purchaseDate').textContent = getCurrentDate();
            showPurchaseInfo();
            
            // Registrar conversão para análise
            if (typeof window.trackConversion === 'function') {
                window.trackConversion('purchase_complete');
            }
            
            // Enviar evento Purchase para Facebook CAPI
            setTimeout(() => {
                sendPurchaseEvent();
            }, 2000); // Aguardar 2s para UTMify carregar
            
            // Configurar redirecionamento automático
            setupAutoRedirect();
        };
    </script>
    

</body>
</html>