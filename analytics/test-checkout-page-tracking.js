/**
 * Teste de Tracking da P√°gina de Checkout
 * Simula o comportamento real de um usu√°rio acessando a p√°gina de checkout
 * e verifica se todos os eventos s√£o disparados corretamente
 */

const axios = require('axios');
const UTMifyFacebookBridge = require('./services/utmify-facebook-bridge');

// Configura√ß√£o do teste
const TEST_CONFIG = {
    checkoutUrl: 'https://descubra-zap.top/checkout/',
    serverUrl: 'http://localhost:3001', // URL do servidor local
    testDuration: 30000, // 30 segundos
    eventInterval: 5000 // 5 segundos entre eventos
};

async function simulateCheckoutPageAccess() {
    console.log('üåê Simulando acesso real √† p√°gina de checkout\n');
    
    try {
        const bridge = new UTMifyFacebookBridge();
        const sessionId = 'real_test_' + Date.now();
        
        console.log('üì± Simulando jornada do usu√°rio:');
        console.log('1. Usu√°rio clica no an√∫ncio do Facebook');
        console.log('2. Usu√°rio navega pelo funil');
        console.log('3. Usu√°rio acessa a p√°gina de checkout');
        console.log('4. Evento InitiateCheckout √© disparado');
        console.log('\n' + '='.repeat(50) + '\n');
        
        // Simular dados realistas de UTM do Facebook
        const utmParams = {
            utm_source: 'facebook',
            utm_medium: 'paid-social',
            utm_campaign: 'descubra_zap_lancamento_2024',
            utm_content: 'video_vsl_30s',
            utm_term: 'descobrir_whatsapp',
            fbclid: 'IwAR2xYz9' + Math.random().toString(36).substr(2, 20),
            utm_id: 'fb_campaign_' + Date.now()
        };
        
        // 1. Simular landing page (p√°gina inicial)
        console.log('1Ô∏è‚É£ Usu√°rio acessa landing page...');
        await bridge.processPageView(sessionId, {
            url: 'https://descubra-zap.top/',
            title: 'Descubra ZAP - Descubra Quem Te Bloqueou',
            referrer: 'https://www.facebook.com/'
        }, utmParams);
        
        await sleep(2000);
        
        // 2. Simular p√°gina de n√∫mero
        console.log('2Ô∏è‚É£ Usu√°rio insere n√∫mero de telefone...');
        await bridge.processPageView(sessionId, {
            url: 'https://descubra-zap.top/numero',
            title: 'Digite seu N√∫mero - Descubra ZAP',
            referrer: 'https://descubra-zap.top/'
        });
        
        await sleep(3000);
        
        // 3. Simular p√°gina de carregamento
        console.log('3Ô∏è‚É£ Usu√°rio aguarda an√°lise...');
        await bridge.processPageView(sessionId, {
            url: 'https://descubra-zap.top/carregando',
            title: 'Analisando... - Descubra ZAP',
            referrer: 'https://descubra-zap.top/numero'
        });
        
        await sleep(5000);
        
        // 4. Simular p√°gina de relat√≥rio
        console.log('4Ô∏è‚É£ Usu√°rio visualiza relat√≥rio...');
        await bridge.processPageView(sessionId, {
            url: 'https://descubra-zap.top/relatorio',
            title: 'Seu Relat√≥rio - Descubra ZAP',
            referrer: 'https://descubra-zap.top/carregando'
        });
        
        // Simular lead capture
        await bridge.processLead(sessionId, {
            email: 'usuario.teste@email.com',
            phone: '+5511987654321',
            name: 'Usu√°rio Teste'
        });
        
        await sleep(10000); // Usu√°rio l√™ o relat√≥rio
        
        // 5. MOMENTO CR√çTICO: Usu√°rio acessa checkout
        console.log('\nüéØ MOMENTO CR√çTICO: Usu√°rio acessa CHECKOUT!');
        console.log('URL:', TEST_CONFIG.checkoutUrl);
        
        const checkoutPageData = {
            url: TEST_CONFIG.checkoutUrl,
            title: 'Checkout - Descubra ZAP Premium',
            referrer: 'https://descubra-zap.top/relatorio'
        };
        
        // PageView do checkout
        const checkoutPageView = await bridge.processPageView(sessionId, checkoutPageData);
        console.log('‚úÖ PageView do checkout processado');
        
        // INITIATE CHECKOUT - O evento principal que estamos testando
        console.log('\nüõí DISPARANDO INITIATE CHECKOUT...');
        
        const checkoutData = {
            productId: 'descubra-zap-premium',
            productName: 'Descubra ZAP Premium - Acesso Completo',
            price: '197.00',
            category: 'digital-service',
            currency: 'BRL'
        };
        
        const initiateCheckoutResult = await bridge.processCheckoutStart(
            sessionId, 
            checkoutData, 
            checkoutPageData
        );
        
        console.log('\nüìä RESULTADO INITIATE CHECKOUT:');
        console.log('- Status:', initiateCheckoutResult.success ? '‚úÖ SUCESSO' : '‚ùå FALHA');
        console.log('- Session ID:', initiateCheckoutResult.sessionId);
        console.log('- Produto:', initiateCheckoutResult.productData?.name);
        console.log('- Valor:', `R$ ${initiateCheckoutResult.productData?.price}`);
        console.log('- UTM Source:', initiateCheckoutResult.utmData?.utm_source);
        console.log('- UTM Campaign:', initiateCheckoutResult.utmData?.utm_campaign);
        console.log('- FBCLID:', initiateCheckoutResult.utmData?.fbclid);
        
        if (initiateCheckoutResult.facebook) {
            console.log('\nüéØ FACEBOOK INTEGRATION:');
            console.log('- Event ID:', initiateCheckoutResult.facebook.eventId);
            console.log('- Pixel Success:', initiateCheckoutResult.facebook.pixel?.success ? '‚úÖ' : '‚ùå');
            console.log('- CAPI Success:', initiateCheckoutResult.facebook.conversionsAPI?.success ? '‚úÖ' : '‚ùå');
            
            if (initiateCheckoutResult.facebook.conversionsAPI?.response) {
                console.log('- Events Received:', initiateCheckoutResult.facebook.conversionsAPI.response.events_received);
                console.log('- FB Trace ID:', initiateCheckoutResult.facebook.conversionsAPI.response.fbtrace_id);
            }
            
            if (initiateCheckoutResult.facebook.error) {
                console.log('- Erro:', initiateCheckoutResult.facebook.error);
            }
        }
        
        // 6. Simular intera√ß√£o com formul√°rio (opcional)
        console.log('\n6Ô∏è‚É£ Usu√°rio interage com formul√°rio de checkout...');
        
        // Simular preenchimento de campos
        await sleep(5000);
        
        // 7. Relat√≥rio final da sess√£o
        console.log('\nüìã RELAT√ìRIO FINAL DA SESS√ÉO:');
        const sessionReport = bridge.getSessionReport(sessionId);
        console.log(JSON.stringify(sessionReport, null, 2));
        
        return {
            success: true,
            sessionId: sessionId,
            initiateCheckoutResult: initiateCheckoutResult,
            sessionReport: sessionReport
        };
        
    } catch (error) {
        console.error('‚ùå Erro na simula√ß√£o:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

// Fun√ß√£o para testar via API HTTP (se o servidor estiver rodando)
async function testCheckoutViaHTTP() {
    console.log('üåê Testando InitiateCheckout via HTTP API\n');
    
    try {
        // Testar se o servidor est√° rodando
        const healthCheck = await axios.get(`${TEST_CONFIG.serverUrl}/health`)
            .catch(() => null);
        
        if (!healthCheck) {
            console.log('‚ö†Ô∏è Servidor n√£o est√° rodando em', TEST_CONFIG.serverUrl);
            console.log('Execute: cd analytics && node server.js');
            return { success: false, error: 'Servidor n√£o dispon√≠vel' };
        }
        
        console.log('‚úÖ Servidor est√° rodando');
        
        // Simular requisi√ß√£o de InitiateCheckout
        const checkoutPayload = {
            sessionId: 'http_test_' + Date.now(),
            eventName: 'InitiateCheckout',
            pageUrl: TEST_CONFIG.checkoutUrl,
            pageTitle: 'Checkout - Descubra ZAP Premium',
            utmData: {
                utm_source: 'facebook',
                utm_medium: 'paid-social',
                utm_campaign: 'http_test_campaign',
                utm_content: 'test_content',
                fbclid: 'IwAR_http_test_' + Date.now()
            },
            customerData: {
                email: 'http.test@email.com',
                phone: '+5511999888777',
                firstName: 'HTTP',
                lastName: 'Test'
            },
            productData: {
                id: 'descubra-zap-premium',
                name: 'Descubra ZAP Premium',
                price: 197.00,
                category: 'digital'
            },
            value: 197.00,
            timestamp: Date.now()
        };
        
        console.log('üì§ Enviando requisi√ß√£o InitiateCheckout...');
        
        const response = await axios.post(
            `${TEST_CONFIG.serverUrl}/api/track-event`,
            checkoutPayload,
            {
                headers: {
                    'Content-Type': 'application/json'
                },
                timeout: 10000
            }
        );
        
        console.log('‚úÖ Resposta recebida:');
        console.log('- Status:', response.status);
        console.log('- Data:', JSON.stringify(response.data, null, 2));
        
        return {
            success: true,
            response: response.data
        };
        
    } catch (error) {
        console.error('‚ùå Erro no teste HTTP:', error.message);
        return {
            success: false,
            error: error.message
        };
    }
}

// Fun√ß√£o para monitorar eventos em tempo real
async function monitorCheckoutEvents() {
    console.log('üëÅÔ∏è Monitorando eventos de checkout em tempo real...');
    console.log('Pressione Ctrl+C para parar\n');
    
    let eventCount = 0;
    
    const monitor = setInterval(async () => {
        eventCount++;
        console.log(`[${new Date().toLocaleTimeString()}] Verifica√ß√£o #${eventCount}`);
        
        // Aqui voc√™ pode implementar l√≥gica para verificar logs
        // ou status de eventos em tempo real
        
    }, TEST_CONFIG.eventInterval);
    
    // Parar ap√≥s dura√ß√£o do teste
    setTimeout(() => {
        clearInterval(monitor);
        console.log('\n‚èπÔ∏è Monitoramento finalizado');
    }, TEST_CONFIG.testDuration);
}

// Fun√ß√£o utilit√°ria para sleep
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Fun√ß√£o principal de teste
async function runAllTests() {
    console.log('üöÄ Iniciando testes completos de InitiateCheckout\n');
    
    const results = {
        simulation: null,
        http: null
    };
    
    // 1. Teste de simula√ß√£o
    console.log('='.repeat(60));
    console.log('1Ô∏è‚É£ TESTE DE SIMULA√á√ÉO');
    console.log('='.repeat(60));
    results.simulation = await simulateCheckoutPageAccess();
    
    await sleep(2000);
    
    // 2. Teste HTTP
    console.log('\n' + '='.repeat(60));
    console.log('2Ô∏è‚É£ TESTE HTTP API');
    console.log('='.repeat(60));
    results.http = await testCheckoutViaHTTP();
    
    // 3. Resumo final
    console.log('\n' + '='.repeat(60));
    console.log('üìä RESUMO DOS TESTES');
    console.log('='.repeat(60));
    console.log('- Simula√ß√£o:', results.simulation?.success ? '‚úÖ PASSOU' : '‚ùå FALHOU');
    console.log('- HTTP API:', results.http?.success ? '‚úÖ PASSOU' : '‚ùå FALHOU');
    
    if (results.simulation?.success && results.http?.success) {
        console.log('\nüéâ TODOS OS TESTES PASSARAM!');
        console.log('\nüìã Pr√≥ximos passos:');
        console.log('1. Acesse o Facebook Events Manager');
        console.log('2. V√° para Test Events do seu Pixel');
        console.log('3. Verifique se os eventos InitiateCheckout aparecem');
        console.log('4. Teste em produ√ß√£o acessando:', TEST_CONFIG.checkoutUrl);
    } else {
        console.log('\n‚ö†Ô∏è Alguns testes falharam. Verifique os logs acima.');
    }
    
    return results;
}

// Executar se chamado diretamente
if (require.main === module) {
    const args = process.argv.slice(2);
    
    if (args.includes('--monitor')) {
        monitorCheckoutEvents();
    } else if (args.includes('--http')) {
        testCheckoutViaHTTP().then(result => {
            process.exit(result.success ? 0 : 1);
        });
    } else if (args.includes('--simulate')) {
        simulateCheckoutPageAccess().then(result => {
            process.exit(result.success ? 0 : 1);
        });
    } else {
        runAllTests().then(results => {
            const allPassed = results.simulation?.success && results.http?.success;
            process.exit(allPassed ? 0 : 1);
        });
    }
}

module.exports = {
    simulateCheckoutPageAccess,
    testCheckoutViaHTTP,
    monitorCheckoutEvents,
    runAllTests
};